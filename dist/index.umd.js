!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("eventemitter3"),require("livekit-client")):"function"==typeof define&&define.amd?define(["exports","eventemitter3","livekit-client"],t):t((e||self).retellClientJsSdk={},e.eventemitter3,e.livekitClient)}(this,function(e,t,o){function n(e,t){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},n(e,t)}function i(e,t){try{var o=e()}catch(e){return t(e)}return o&&o.then?o.then(void 0,t):o}var a=new TextDecoder;e.RetellWebClient=/*#__PURE__*/function(e){var t,r;function d(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.audioContext=void 0,t.sampleRate=void 0,t.isAgentTalking=!1,t.audioAnalyzerNode=void 0,t.captureAudioFrame=void 0,t}r=e,(t=d).prototype=Object.create(r.prototype),t.prototype.constructor=t,n(t,r);var u=d.prototype;return u.getNewAudioContext=function(e){if("undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext))return new AudioContext({latencyHint:"interactive",sampleRate:e.sampleRate})},u.startCall=function(e){try{var t=this;return Promise.resolve(i(function(){function n(n){return t.sampleRate=t.audioContext.sampleRate,t.room=new o.Room({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId},webAudioMix:{audioContext:t.audioContext}}),t.handleRoomEvents(),e.emitRawAudioSamples&&(t.audioAnalyzerNode=t.audioContext.createAnalyser(),t.audioAnalyzerNode.fftSize=2048),t.handleAudioEvents(e),t.handleDataEvents(),Promise.resolve(t.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){console.log("connected to room",t.room.name),t.room.localParticipant.setMicrophoneEnabled(!0),t.connected=!0,t.emit("call_started"),e.emitRawAudioSamples&&(t.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()}))})}var a=t.getNewAudioContext(e);if(null==a)throw new Error("AudioContext not supported");t.audioContext=a;var r=function(){if("suspended"===t.audioContext.state)return i(function(){return Promise.resolve(t.audioContext.resume()).then(function(){})},function(e){throw console.warn("Could not resume audio context",{error:e}),new Error("AudioContext cannot be resumed")})}();return r&&r.then?r.then(n):n()},function(e){t.emit("error","Error starting call"),console.error("Error starting call",e),t.stopCall()}))}catch(e){return Promise.reject(e)}},u.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},u.stopCall=function(){var e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect()),this.isAgentTalking=!1,delete this.room,delete this.sampleRate,this.audioAnalyzerNode&&(this.audioAnalyzerNode.disconnect(),delete this.audioAnalyzerNode),this.audioContext&&(this.audioContext.close(),delete this.audioContext),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame)},u.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},u.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},u.captureAudioSamples=function(){var e=this;if(this.connected&&this.audioAnalyzerNode){var t=new Float32Array(this.audioAnalyzerNode.fftSize);this.audioAnalyzerNode.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},u.handleRoomEvents=function(){var e=this;this.room.on(o.RoomEvent.ParticipantDisconnected,function(t){"server"===(null==t?void 0:t.identity)&&e.stopCall()}),this.room.on(o.RoomEvent.Disconnected,function(){e.connected&&e.stopCall()})},u.handleAudioEvents=function(e){var t=this;this.room.on(o.RoomEvent.TrackSubscribed,function(n,i,a){n.kind===o.Track.Kind.Audio&&(n instanceof o.RemoteAudioTrack&&e.emitRawAudioSamples&&n.setWebAudioPlugins([t.audioAnalyzerNode]),n.attach())})},u.handleDataEvents=function(){var e=this;this.room.on(o.RoomEvent.DataReceived,function(t,o,n,i){try{if("server"!==(null==o?void 0:o.identity))return;var r=a.decode(t),d=JSON.parse(r);"update"===d.event_type?e.emit("update",d):"metadata"===d.event_type?e.emit("metadata",d):"agent_start_talking"===d.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===d.event_type&&(e.isAgentTalking=!1,e.emit("agent_stop_talking"))}catch(e){console.error("Error decoding data received",e)}})},d}(t.EventEmitter)});
