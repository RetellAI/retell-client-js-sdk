!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("retell-sdk"),require("retell-sdk/models/components/calldetail")):"function"==typeof define&&define.amd?define(["exports","retell-sdk","retell-sdk/models/components/calldetail"],t):t((e||self).retellClientJsSdk={},e.retellSdk,e.calldetail)}(this,function(e,t,n){function o(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}e.RetellClientSdk=/*#__PURE__*/function(){function e(e){this.retell=void 0,this.liveClient=null,this.audioContext=null,this.isCalling=!1,this.stream=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0,this.eventListeners={onConversationStarted:[],onConversationEnded:[],onError:[]},this.retell=new t.RetellClient({apiKey:e})}var i=e.prototype;return i.startConversation=function(e){var i=e.agentId,r=e.sampleRate,a=void 0===r?22050:r,s=e.audioEncoding,l=void 0===s?n.AudioEncoding.S16le:s,u=e.customStream,d=void 0===u?null:u;try{var c=this;return Promise.resolve(o(function(){return Promise.resolve(c.setupAudio(a,d)).then(function(){return Promise.resolve(c.retell.registerCall({agentId:i,audioWebsocketProtocol:n.AudioWebsocketProtocol.Web,audioEncoding:l,sampleRate:a})).then(function(e){if(!e||!e.callDetail)throw new Error("Register call failed");c.liveClient=new t.AudioWsClient(e.callDetail.callId),c.handleAudioEvents(),c.isCalling=!0,c.audioContext.resume(),c.triggerEvent("onConversationStarted")})})},function(e){c.triggerEvent("onError",e.message)}))}catch(e){return Promise.reject(e)}},i.stopConversation=function(){var e,t,n;this.isCalling=!1,null==(e=this.liveClient)||e.close(),null==(t=this.audioContext)||t.suspend(),this.captureNode&&(this.captureNode.disconnect(),this.captureNode.onaudioprocess=null),this.audioContext&&this.audioContext.close(),null==(n=this.stream)||n.getTracks().forEach(function(e){return e.stop()}),this.liveClient=null,this.audioContext=null,this.stream=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0,this.triggerEvent("onConversationEnded")},i.on=function(e,t){this.eventListeners[e]&&this.eventListeners[e].push(t)},i.setupAudio=function(e,n){void 0===n&&(n=null);try{var i=function(e){var n=r.audioContext.createMediaStreamSource(r.stream);r.captureNode=r.audioContext.createScriptProcessor(2048,1,1),r.captureNode.onaudioprocess=function(e){if(r.isCalling){var n=e.inputBuffer.getChannelData(0),o=t.convertFloat32ToUint8(n);r.liveClient.send(o);for(var i=e.outputBuffer.getChannelData(0),a=0;a<i.length;++a)r.audioData.length>0?(i[a]=r.audioData[0][r.audioDataIndex++],r.audioDataIndex===r.audioData[0].length&&(r.audioData.shift(),r.audioDataIndex=0)):i[a]=0}},n.connect(r.captureNode),r.captureNode.connect(r.audioContext.destination)},r=this;r.audioContext=new AudioContext({sampleRate:e});var a=o(function(){function t(e){r.stream=e}return n?t(n):Promise.resolve(navigator.mediaDevices.getUserMedia({audio:{sampleRate:e,echoCancellation:!0,noiseSuppression:!0,channelCount:1}})).then(t)},function(){throw new Error("User didn't give microphone permission")});return Promise.resolve(a&&a.then?a.then(i):i())}catch(e){return Promise.reject(e)}},i.handleAudioEvents=function(){var e=this;this.liveClient.on("audio",function(n){var o=t.convertUint8ToFloat32(n);e.audioData.push(o)}),this.liveClient.on("error",function(t){e.triggerEvent("onError",t),e.stopConversation()}),this.liveClient.on("close",function(t,n){e.stopConversation(),e.triggerEvent("onConversationEnded",{code:t,reason:n})})},i.triggerEvent=function(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e(t)})},e}()});
