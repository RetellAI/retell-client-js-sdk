!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("eventemitter3"),require("isomorphic-ws")):"function"==typeof define&&define.amd?define(["exports","eventemitter3","isomorphic-ws"],t):t((e||self).retellClientJsSdk={},e.eventemitter3,e.isomorphicWs)}(this,function(e,t,n){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=/*#__PURE__*/o(n);function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,r(e,t)}function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}var s=/*#__PURE__*/function(e){function t(t){var n;(n=e.call(this)||this).ws=void 0;var o=(t.customEndpoint||"wss://api.retellai.com/audio-websocket/")+t.callId;return t.enableUpdate&&(o+="?enable_update=true"),n.ws=new i.default(o),n.ws.binaryType="arraybuffer",n.ws.onopen=function(){n.emit("open")},n.ws.onmessage=function(e){if("string"==typeof e.data)if("clear"===e.data)n.emit("clear");else try{var t=JSON.parse(e.data);n.emit("update",t)}catch(e){n.emit("error","Error parsing JSON update from server."),n.ws.close(1002,"Error parsing JSON update from server.")}else if(e.data instanceof ArrayBuffer){var o=new Uint8Array(e.data);n.emit("audio",o)}else n.emit("error","Got unknown message from server."),n.ws.close(1002,"Got unknown message from server.")},n.ws.onclose=function(e){n.emit("close",e.code,e.reason)},n.ws.onerror=function(e){n.emit("error",e.error)},n}a(t,e);var n=t.prototype;return n.send=function(e){1===this.ws.readyState&&this.ws.send(e)},n.close=function(){this.ws.close()},t}(t.EventEmitter);function u(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}e.RetellWebClient=/*#__PURE__*/function(e){function t(t){var n;return(n=e.call(this)||this).liveClient=void 0,n.audioContext=void 0,n.isCalling=!1,n.stream=void 0,n.audioNode=void 0,n.customEndpoint=void 0,n.captureNode=null,n.audioData=[],n.audioDataIndex=0,t&&(n.customEndpoint=t),n}a(t,e);var n=t.prototype;return n.startConversation=function(e){try{var t=this,n=u(function(){return Promise.resolve(t.setupAudioPlayback(e.sampleRate,e.customStream)).then(function(){t.liveClient=new s({callId:e.callId,enableUpdate:e.enableUpdate,customEndpoint:t.customEndpoint}),t.handleAudioEvents(),t.isCalling=!0})},function(e){t.emit("error",e.message)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},n.stopConversation=function(){var e,t,n,o,i;this.isCalling=!1,null==(e=this.liveClient)||e.close(),null==(t=this.audioContext)||t.suspend(),null==(n=this.audioContext)||n.close(),this.isAudioWorkletSupported()?(null==(i=this.audioNode)||i.disconnect(),this.audioNode=null):this.captureNode&&(this.captureNode.disconnect(),this.captureNode.onaudioprocess=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0),this.liveClient=null,null==(o=this.stream)||o.getTracks().forEach(function(e){return e.stop()}),this.audioContext=null,this.stream=null},n.handleAudioEvents=function(){var e=this;this.liveClient.on("open",function(){e.emit("conversationStarted")}),this.liveClient.on("audio",function(t){e.playAudio(t),e.emit("audio",t)}),this.liveClient.on("error",function(t){e.emit("error",t),e.isCalling&&e.stopConversation()}),this.liveClient.on("close",function(t,n){e.isCalling&&e.stopConversation(),e.emit("conversationEnded",{code:t,reason:n})}),this.liveClient.on("update",function(t){e.emit("update",t)}),this.liveClient.on("clear",function(){e.isAudioWorkletSupported()?e.audioNode.port.postMessage("clear"):(e.audioData=[],e.audioDataIndex=0)})},n.setupAudioPlayback=function(e,t){try{var n=this;return Promise.resolve(function(){if(n.isAudioWorkletSupported()){var o=function(e){console.log("Audio worklet starting"),n.audioContext.resume();var t=new Blob(['\nclass captureAndPlaybackProcessor extends AudioWorkletProcessor {\n    audioData = [];\n    index = 0;\n  \n    constructor() {\n      super();\n      //set listener to receive audio data, data is float32 array.\n      this.port.onmessage = (e) => {\n        if (e.data === "clear") {\n          // Clear all buffer.\n          this.audioData = [];\n          this.index = 0;\n        } else if (e.data.length > 0) {\n          this.audioData.push(this.convertUint8ToFloat32(e.data));\n        }\n      };\n    }\n  \n    convertUint8ToFloat32(array) {\n      const targetArray = new Float32Array(array.byteLength / 2);\n    \n      // A DataView is used to read our 16-bit little-endian samples out of the Uint8Array buffer\n      const sourceDataView = new DataView(array.buffer);\n    \n      // Loop through, get values, and divide by 32,768\n      for (let i = 0; i < targetArray.length; i++) {\n        targetArray[i] = sourceDataView.getInt16(i * 2, true) / Math.pow(2, 16 - 1);\n      }\n      return targetArray;\n    }\n  \n    convertFloat32ToUint8(array) {\n      const buffer = new ArrayBuffer(array.length * 2);\n      const view = new DataView(buffer);\n    \n      for (let i = 0; i < array.length; i++) {\n        const value = array[i] * 32768;\n        view.setInt16(i * 2, value, true); // true for little-endian\n      }\n    \n      return new Uint8Array(buffer);\n    }\n  \n    process(inputs, outputs, parameters) {\n      // Capture\n      const input = inputs[0];\n      const inputChannel1 = input[0];\n      const inputChannel2 = input[1];\n      this.port.postMessage(this.convertFloat32ToUint8(inputChannel1));\n  \n      // Playback\n      const output = outputs[0];\n      const outputChannel1 = output[0];\n      const outputChannel2 = output[1];\n      // start playback.\n      for (let i = 0; i < outputChannel1.length; ++i) {\n        if (this.audioData.length > 0) {\n          outputChannel1[i] = this.audioData[0][this.index];\n          outputChannel2[i] = this.audioData[0][this.index];\n          this.index++;\n          if (this.index == this.audioData[0].length) {\n            this.audioData.shift();\n            this.index = 0;\n          }\n        } else {\n          outputChannel1[i] = 0;\n          outputChannel2[i] = 0;\n        }\n      }\n  \n      return true;\n    }\n  }\n  \n  registerProcessor(\n    "capture-and-playback-processor",\n    captureAndPlaybackProcessor,\n  );\n'],{type:"application/javascript"}),o=URL.createObjectURL(t);return Promise.resolve(n.audioContext.audioWorklet.addModule(o)).then(function(){console.log("Audio worklet loaded"),n.audioNode=new AudioWorkletNode(n.audioContext,"capture-and-playback-processor"),console.log("Audio worklet setup"),n.audioNode.port.onmessage=function(e){null!=n.liveClient&&n.liveClient.send(e.data)},n.audioContext.createMediaStreamSource(n.stream).connect(n.audioNode),n.audioNode.connect(n.audioContext.destination)})};n.audioContext=new AudioContext({sampleRate:e});var i=u(function(){function o(e){n.stream=e}return t?o(t):Promise.resolve(navigator.mediaDevices.getUserMedia({audio:{sampleRate:e,echoCancellation:!0,noiseSuppression:!0,channelCount:1}})).then(o)},function(){throw new Error("User didn't give microphone permission")});return i&&i.then?i.then(o):o()}var a=function(e){var t=n.audioContext.createMediaStreamSource(n.stream);n.captureNode=n.audioContext.createScriptProcessor(2048,1,1),n.captureNode.onaudioprocess=function(e){if(n.isCalling){var t=function(e){for(var t=new ArrayBuffer(2*e.length),n=new DataView(t),o=0;o<e.length;o++)n.setInt16(2*o,32768*e[o],!0);return new Uint8Array(t)}(e.inputBuffer.getChannelData(0));n.liveClient.send(t);for(var o=e.outputBuffer.getChannelData(0),i=0;i<o.length;++i)n.audioData.length>0?(o[i]=n.audioData[0][n.audioDataIndex++],n.audioDataIndex===n.audioData[0].length&&(n.audioData.shift(),n.audioDataIndex=0)):o[i]=0}},t.connect(n.captureNode),n.captureNode.connect(n.audioContext.destination)};n.audioContext=new AudioContext({sampleRate:e});var r=u(function(){function o(e){n.stream=e}return t?o(t):Promise.resolve(navigator.mediaDevices.getUserMedia({audio:{sampleRate:e,echoCancellation:!0,noiseSuppression:!0,channelCount:1}})).then(o)},function(){throw new Error("User didn't give microphone permission")});return r&&r.then?r.then(a):a()}())}catch(e){return Promise.reject(e)}},n.isAudioWorkletSupported=function(){return/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)},n.playAudio=function(e){if(this.isAudioWorkletSupported())this.audioNode.port.postMessage(e);else{var t=function(e){for(var t=new Float32Array(e.byteLength/2),n=new DataView(e.buffer),o=0;o<t.length;o++)t[o]=n.getInt16(2*o,!0)/Math.pow(2,15);return t}(e);this.audioData.push(t)}},t}(t.EventEmitter)});
