import{EventEmitter as e}from"eventemitter3";import{Room as t,RoomEvent as o,Track as n,RemoteAudioTrack as i}from"livekit-client";function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}function r(e,t){try{var o=e()}catch(e){return t(e)}return o&&o.then?o.then(void 0,t):o}var u=new TextDecoder,c=/*#__PURE__*/function(e){var c,d;function s(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.audioContext=void 0,t.sampleRate=void 0,t.isAgentTalking=!1,t.audioAnalyzerNode=void 0,t.captureAudioFrame=void 0,t}d=e,(c=s).prototype=Object.create(d.prototype),c.prototype.constructor=c,a(c,d);var l=s.prototype;return l.getNewAudioContext=function(e){if("undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext))return new AudioContext({latencyHint:"interactive",sampleRate:e.sampleRate})},l.startCall=function(e){try{var n=this;return Promise.resolve(r(function(){function i(i){return n.sampleRate=n.audioContext.sampleRate,n.room=new t({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId},webAudioMix:{audioContext:n.audioContext}}),n.room.on(o.Disconnected,function(){n.connected&&(n.connected=!1,n.room.disconnect(),n.emit("call_ended"))}),e.emitRawAudioSamples&&(n.audioAnalyzerNode=n.audioContext.createAnalyser(),n.audioAnalyzerNode.fftSize=2048),n.handleAudioEvents(e),n.handleDataEvents(),Promise.resolve(n.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){console.log("connected to room",n.room.name),n.room.localParticipant.setMicrophoneEnabled(!0),n.connected=!0,n.emit("call_started"),e.emitRawAudioSamples&&(n.captureAudioFrame=window.requestAnimationFrame(function(){return n.captureAudioSamples()}))})}var a=n.getNewAudioContext(e);if(null==a)throw new Error("AudioContext not supported");n.audioContext=a;var u=function(){if("suspended"===n.audioContext.state)return r(function(){return Promise.resolve(n.audioContext.resume()).then(function(){})},function(e){throw console.warn("Could not resume audio context",{error:e}),new Error("AudioContext cannot be resumed")})}();return u&&u.then?u.then(i):i()},function(e){n.emit("error","Error starting call"),console.error("Error starting call",e),n.stopCall()}))}catch(e){return Promise.reject(e)}},l.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},l.stopCall=function(){var e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect()),this.isAgentTalking=!1,delete this.room,this.audioContext&&(this.audioContext.close(),delete this.audioContext),delete this.sampleRate,delete this.audioAnalyzerNode,this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame)},l.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},l.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},l.captureAudioSamples=function(){var e=this;if(this.connected&&this.audioAnalyzerNode){var t=new Float32Array(this.audioAnalyzerNode.fftSize);this.audioAnalyzerNode.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},l.handleAudioEvents=function(e){var t=this;this.room.on(o.TrackSubscribed,function(o,a,r){o.kind===n.Kind.Audio&&(o instanceof i&&e.emitRawAudioSamples&&o.setWebAudioPlugins([t.audioAnalyzerNode]),o.attach())})},l.handleDataEvents=function(){var e=this;this.room.on(o.DataReceived,function(t,o,n,i){try{if("server"!==(null==o?void 0:o.identity))return;var a=u.decode(t),r=JSON.parse(a);"update"===r.event_type?e.emit("update",r):"metadata"===r.event_type?e.emit("metadata",r):"agent_start_talking"===r.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===r.event_type&&(e.isAgentTalking=!1,e.emit("agent_stop_talking"))}catch(e){console.error("Error decoding data received",e)}})},s}(e);export{c as RetellWebClient};
