import{AudioWsClient as e,convertFloat32ToUint8 as t,convertUint8ToFloat32 as n,RetellClient as o}from"retell-sdk";import{AudioWebsocketProtocol as i,AudioEncoding as r}from"retell-sdk/models/components/calldetail";function a(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var s=/*#__PURE__*/function(){function s(e){this.retell=void 0,this.liveClient=null,this.audioContext=null,this.isCalling=!1,this.stream=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0,this.eventListeners={onConversationStarted:[],onConversationEnded:[],onError:[]},this.retell=new o({apiKey:e})}var u=s.prototype;return u.startConversation=function(t){var n=t.agentId,o=t.sampleRate,s=void 0===o?22050:o,u=t.audioEncoding,l=void 0===u?r.S16le:u,d=t.customStream,c=void 0===d?null:d;try{var h=this;return Promise.resolve(a(function(){return Promise.resolve(h.setupAudio(s,c)).then(function(){return Promise.resolve(h.retell.registerCall({agentId:n,audioWebsocketProtocol:i.Web,audioEncoding:l,sampleRate:s})).then(function(t){if(!t||!t.callDetail)throw new Error("Register call failed");h.liveClient=new e(t.callDetail.callId),h.handleAudioEvents(),h.isCalling=!0,h.audioContext.resume(),h.triggerEvent("onConversationStarted")})})},function(e){h.triggerEvent("onError",e.message)}))}catch(e){return Promise.reject(e)}},u.stopConversation=function(){var e,t,n;this.isCalling=!1,null==(e=this.liveClient)||e.close(),null==(t=this.audioContext)||t.suspend(),this.captureNode&&(this.captureNode.disconnect(),this.captureNode.onaudioprocess=null),this.audioContext&&this.audioContext.close(),null==(n=this.stream)||n.getTracks().forEach(function(e){return e.stop()}),this.liveClient=null,this.audioContext=null,this.stream=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0,this.triggerEvent("onConversationEnded")},u.on=function(e,t){this.eventListeners[e]&&this.eventListeners[e].push(t)},u.setupAudio=function(e,n){void 0===n&&(n=null);try{var o=function(e){var n=i.audioContext.createMediaStreamSource(i.stream);i.captureNode=i.audioContext.createScriptProcessor(2048,1,1),i.captureNode.onaudioprocess=function(e){if(i.isCalling){var n=e.inputBuffer.getChannelData(0),o=t(n);i.liveClient.send(o);for(var r=e.outputBuffer.getChannelData(0),a=0;a<r.length;++a)i.audioData.length>0?(r[a]=i.audioData[0][i.audioDataIndex++],i.audioDataIndex===i.audioData[0].length&&(i.audioData.shift(),i.audioDataIndex=0)):r[a]=0}},n.connect(i.captureNode),i.captureNode.connect(i.audioContext.destination)},i=this;i.audioContext=new AudioContext({sampleRate:e});var r=a(function(){function t(e){i.stream=e}return n?t(n):Promise.resolve(navigator.mediaDevices.getUserMedia({audio:{sampleRate:e,echoCancellation:!0,noiseSuppression:!0,channelCount:1}})).then(t)},function(){throw new Error("User didn't give microphone permission")});return Promise.resolve(r&&r.then?r.then(o):o())}catch(e){return Promise.reject(e)}},u.handleAudioEvents=function(){var e=this;this.liveClient.on("audio",function(t){var o=n(t);e.audioData.push(o)}),this.liveClient.on("error",function(t){e.triggerEvent("onError",t),e.stopConversation()}),this.liveClient.on("close",function(t,n){e.stopConversation(),e.triggerEvent("onConversationEnded",{code:t,reason:n})})},u.triggerEvent=function(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e(t)})},s}();export{s as RetellClientSdk};
