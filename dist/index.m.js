import{AudioWsClient as t,convertFloat32ToUint8 as e,convertUint8ToFloat32 as n}from"retell-sdk";function i(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}var o=/*#__PURE__*/function(){function o(){this.liveClient=null,this.audioContext=null,this.isCalling=!1,this.stream=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0,this.eventListeners={onConversationStarted:[],onConversationEnded:[],onError:[]}}var r=o.prototype;return r.startConversation=function(e){var n=e.callId,o=e.sampleRate,r=void 0===o?22050:o,a=e.customStream,s=void 0===a?null:a;try{var u=this,l=i(function(){return Promise.resolve(u.setupAudio(r,s)).then(function(){u.liveClient=new t(n),u.handleAudioEvents(),u.isCalling=!0,u.audioContext.resume(),u.triggerEvent("onConversationStarted")})},function(t){u.triggerEvent("onError",t.message)});return Promise.resolve(l&&l.then?l.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},r.stopConversation=function(){var t,e,n;this.isCalling=!1,null==(t=this.liveClient)||t.close(),null==(e=this.audioContext)||e.suspend(),this.captureNode&&(this.captureNode.disconnect(),this.captureNode.onaudioprocess=null),this.audioContext&&this.audioContext.close(),null==(n=this.stream)||n.getTracks().forEach(function(t){return t.stop()}),this.liveClient=null,this.audioContext=null,this.stream=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0,this.triggerEvent("onConversationEnded")},r.on=function(t,e){this.eventListeners[t]&&this.eventListeners[t].push(e)},r.setupAudio=function(t,n){void 0===n&&(n=null);try{var o=function(t){var n=r.audioContext.createMediaStreamSource(r.stream);r.captureNode=r.audioContext.createScriptProcessor(2048,1,1),r.captureNode.onaudioprocess=function(t){if(r.isCalling){var n=t.inputBuffer.getChannelData(0),i=e(n);r.liveClient.send(i);for(var o=t.outputBuffer.getChannelData(0),a=0;a<o.length;++a)r.audioData.length>0?(o[a]=r.audioData[0][r.audioDataIndex++],r.audioDataIndex===r.audioData[0].length&&(r.audioData.shift(),r.audioDataIndex=0)):o[a]=0}},n.connect(r.captureNode),r.captureNode.connect(r.audioContext.destination)},r=this;r.audioContext=new AudioContext({sampleRate:t});var a=i(function(){function e(t){r.stream=t}return n?e(n):Promise.resolve(navigator.mediaDevices.getUserMedia({audio:{sampleRate:t,echoCancellation:!0,noiseSuppression:!0,channelCount:1}})).then(e)},function(){throw new Error("User didn't give microphone permission")});return Promise.resolve(a&&a.then?a.then(o):o())}catch(t){return Promise.reject(t)}},r.handleAudioEvents=function(){var t=this;this.liveClient.on("audio",function(e){var i=n(e);t.audioData.push(i)}),this.liveClient.on("error",function(e){t.triggerEvent("onError",e),t.stopConversation()}),this.liveClient.on("close",function(e,n){t.stopConversation(),t.triggerEvent("onConversationEnded",{code:e,reason:n})})},r.triggerEvent=function(t,e){this.eventListeners[t]&&this.eventListeners[t].forEach(function(t){return t(e)})},o}();export{o as RetellClientSdk};
