var e=require("eventemitter3"),t=require("livekit-client");function n(e,t){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},n(e,t)}var o=new TextDecoder;exports.RetellWebClient=/*#__PURE__*/function(e){var a,i;function r(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.isAgentTalking=!1,t.analyzerComponent=void 0,t.captureAudioFrame=void 0,t}i=e,(a=r).prototype=Object.create(i.prototype),a.prototype.constructor=a,n(a,i);var c=r.prototype;return c.startCall=function(e){try{var n=this,o=function(o,a){try{var i=(n.room=new t.Room({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId}}),n.handleRoomEvents(),n.handleAudioEvents(e),n.handleDataEvents(),Promise.resolve(n.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){console.log("connected to room",n.room.name),n.room.localParticipant.setMicrophoneEnabled(!0),n.connected=!0,n.emit("call_started")}))}catch(e){return a(e)}return i&&i.then?i.then(void 0,a):i}(0,function(e){n.emit("error","Error starting call"),console.error("Error starting call",e),n.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},c.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},c.stopCall=function(){var e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect()),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame)},c.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},c.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},c.captureAudioSamples=function(){var e=this;if(this.connected&&this.analyzerComponent){var t=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},c.handleRoomEvents=function(){var e=this;this.room.on(t.RoomEvent.ParticipantDisconnected,function(t){"server"===(null==t?void 0:t.identity)&&e.stopCall()}),this.room.on(t.RoomEvent.Disconnected,function(){e.connected&&e.stopCall()})},c.handleAudioEvents=function(e){var n=this;this.room.on(t.RoomEvent.TrackSubscribed,function(o,a,i){o.kind===t.Track.Kind.Audio&&("agent_audio"===a.trackName&&o instanceof t.RemoteAudioTrack&&e.emitRawAudioSamples&&(n.analyzerComponent=t.createAudioAnalyser(o),n.captureAudioFrame=window.requestAnimationFrame(function(){return n.captureAudioSamples()})),o.attach())})},c.handleDataEvents=function(){var e=this;this.room.on(t.RoomEvent.DataReceived,function(t,n,a,i){try{if("server"!==(null==n?void 0:n.identity))return;var r=o.decode(t),c=JSON.parse(r);"update"===c.event_type?e.emit("update",c):"metadata"===c.event_type?e.emit("metadata",c):"agent_start_talking"===c.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===c.event_type&&(e.isAgentTalking=!1,e.emit("agent_stop_talking"))}catch(e){console.error("Error decoding data received",e)}})},r}(e.EventEmitter);
