var t=require("eventemitter3"),e=require("livekit-client");function n(t,e){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},n(t,e)}var o=new TextDecoder;exports.RetellWebClient=/*#__PURE__*/function(t){var i,a;function r(){var e;return(e=t.call(this)||this).room=void 0,e.connected=!1,e.isAgentTalking=!1,e.analyzerComponent=void 0,e.captureAudioFrame=void 0,e}a=t,(i=r).prototype=Object.create(a.prototype),i.prototype.constructor=i,n(i,a);var c=r.prototype;return c.startCall=function(t){try{var n=this,o=function(o,i){try{var a=(n.room=new e.Room({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:t.captureDeviceId,sampleRate:t.sampleRate},audioOutput:{deviceId:t.playbackDeviceId}}),n.handleRoomEvents(),n.handleAudioEvents(t),n.handleDataEvents(),Promise.resolve(n.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",t.accessToken)).then(function(){console.log("connected to room",n.room.name),n.room.localParticipant.setMicrophoneEnabled(!0),n.connected=!0,n.emit("call_started")}))}catch(t){return i(t)}return a&&a.then?a.then(void 0,i):a}(0,function(t){n.emit("error","Error starting call"),console.error("Error starting call",t),n.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},c.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(t){return Promise.reject(t)}},c.stopCall=function(){var t;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(t=this.room)||t.disconnect()),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame)},c.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},c.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},c.captureAudioSamples=function(){var t=this;if(this.connected&&this.analyzerComponent){var e=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(e),this.emit("audio",e),this.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()})}},c.handleRoomEvents=function(){var t=this;this.room.on(e.RoomEvent.ParticipantDisconnected,function(e){"server"===(null==e?void 0:e.identity)&&t.stopCall()}),this.room.on(e.RoomEvent.Disconnected,function(){t.connected&&t.stopCall()})},c.handleAudioEvents=function(t){var n=this;this.room.on(e.RoomEvent.TrackSubscribed,function(o,i,a){o.kind===e.Track.Kind.Audio&&("agent_audio"===i.trackName&&o instanceof e.RemoteAudioTrack&&t.emitRawAudioSamples&&(n.analyzerComponent=e.createAudioAnalyser(o),n.captureAudioFrame=window.requestAnimationFrame(function(){return n.captureAudioSamples()})),o.attach())})},c.handleDataEvents=function(){var t=this;this.room.on(e.RoomEvent.DataReceived,function(e,n,i,a){try{if("server"!==(null==n?void 0:n.identity))return;var r=o.decode(e),c=JSON.parse(r);"update"===c.event_type?t.emit("update",c):"metadata"===c.event_type?t.emit("metadata",c):"agent_start_talking"===c.event_type?(t.isAgentTalking=!0,t.emit("agent_start_talking")):"agent_stop_talking"===c.event_type?(t.isAgentTalking=!1,t.emit("agent_stop_talking")):"node_transition"===c.event_type&&t.emit("node_transition",c)}catch(t){console.error("Error decoding data received",t)}})},r}(t.EventEmitter);
